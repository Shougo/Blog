---
title: "新世代の UI 作成プラグイン ddu.vim"
emoji: "🖤"
type: "tech"
topics: ["vim", "neovim", "denops"]
published: true
---

# 始めに

Note: この記事は「新世代の自動補完プラグイン ddc.vim」の続編となります。

ddc.vim の開発が一通り終了し、ようやく ddu.vim の開発にとりかかることができました。
ここにきて一通りの機能がそろいましたので、広くユーザーに使ってもらうフェーズに進めたいと考えています。
ddc.vim のときと同様に、ユーザーからの要望やバグ報告に対応が終わってから正式版の 1.0 をリリースしようと考えています。

https://github.com/Shougo/ddu.vim

私が以前に作成したファジーファインダープラグインである denite.nvim は既に開発を終了しました。
私自身は既に denite.nvim から ddu.vim に移行しています。ddu.vim に denite.nvim の一部機能はまだ実装されていませんが、自分が使うぶんには十分です。


# UI 作成プラグインとは

そもそも、unite.vim, denite.nvim の時代からファジーファインダーを作りたかったわけではないのです。
UI 作成フレームワークを作成したかったのです。


# ファジーファインダーフレームワーク開発の歴史

私はこれまでいくつかのファジーファインダーを開発してきました。その歴史を振り返ってみることにしましょう。


## unite.vim 2010/07 頃開発

https://github.com/Shougo/unite.vim

そもそも unite.vim を開発するきっかけは、私が anything.el (2008 年頃登場) に憧れており Vim でも似たようなことをしようと思っていたためです。

https://github.com/emacs-jp/anything

anything.el というフレームワークを利用することで、あらゆる操作を統一したインタフェースで行うというのは私の理想形でした。

当時は Vim プラグインのファジーファインダーとして FuzzyFinder(vim-fuzzyfinder) や vim-ku というものがあり私はそれらを使っていました。

https://www.vim.org/scripts/script.php?script_id=1984

https://github.com/kana/vim-ku

しかし、それらは anything.el と比較していくつか欠点がありました。

* 候補の表示と選択に補完メニューを使うために自由度が低い

* 開発が止まっている

* 機能が少ない

Note: ちなみに unite.vim の各種 API は vim-ku の影響を受けています。kind という概念や custom API、define で source を定義する部分などです。vim-ku の提唱した UI フレームワークという基本的な概念を自分が再実装したのが unite.vim と考えることができます。

unite.vim の特徴は以下の通りです。

* 多数のオプションに対応

* source, filter, kind という概念による拡張性

* normal mode, insert mode 両方に対応

unite.vim は拡張に拡張を重ねた結果 2010 年当時に開発されたプラグインとしては完成度が高く、2022 年になっても機能的には見劣りがしません。
未だに unite.vim を使用している人がいるほどです。

しかし unite.vim も万能というわけではなく、以下のような欠点がありました。

* 無理矢理拡張しており、内部構造が巨大になってしまったので今後のメンテナンスや拡張が困難

* パフォーマンスが悪い。数万の候補をまともに処理できない

unite.vim のパフォーマンス問題を軽減させるために一部処理を Lua に対応しましたが焼け石に水、その後 Vim の Lua インタフェースの互換性が壊れる事件により Lua コードは削除されることになります。

unite.vim の欠点を解消させるために、今後私は新たなプラグインを開発していくことになるのでした。


## denite.nvim 2016/02 頃開発

https://github.com/Shougo/denite.nvim

unite.vim の後継となる denite.nvim の開発には unite.vim から六年もの歳月がかかりました。
なぜここまで時間がかかったかというと、unite.vim を拡張したり vimfiler.vim を開発していたためです。

unite.vim に代わる次のプラグインは必要でしたが、そのためのブレイクスルーはまだありませんでした。

当初 denite.nvim はユーザーの入力を乗っ取ることで独自のイベントループを実装していました。
これには他のプラグインや設定とコンフリクトしにくい利点があったのですが、同時に欠点も抱えていました。

後に denite.nvim には型情報の追加を行い、堅牢性を高めることになりました。
denite.nvim はパフォーマンスの向上、保守のしやすさ、Python の豊富なライブラリを利用できることで
unite.vim の上位互換としての地位を確立することができました。

しかし denite.nvim も万能ではありません。denite.nvim の欠点は以下です。

* Python に依存している

* Python のインストール環境は様々で、環境により不可解なエラーが起こることがあり解決が困難

* 絞り込み処理が非同期化できておらず、処理のボトルネックになっている

* neovim はリモートプラグイン API のメンテナンスではなく、 Lua API を優先しており将来がない

* Vim8 との互換性が古い、Vim8 環境でのパフォーマンスが悪い

denite.nvim 開発後期になると、リモートプラグインに代わり Lua で書かれた neovim プラグインがプラグイン界隈を圧巻しはじめます。
それはファジーファインダー界隈でも例外ではありませんでした。

https://github.com/nvim-telescope/telescope.nvim

telescope.nvim は neovim 利用者に圧倒的速度で広まり、現在ではデファクトスタンダードの地位を確立しています。

しかし私は Lua で新たなプラグインを作成する気はありませんでした。自分が Lua を選択しなかったのは以下が理由です。

* neovim でしか動作しない

* Lua は立場として高速な Vim script であり処理が固まる問題を解決ができない。Vim9 script も同様の問題を抱える

* ライブラリが貧弱である

* 型をつけられないので堅牢性に問題がある、巨大なプラグインの保守が困難

denite.nvim の行く末に不安を感じつつも、次のブレイクスルーが起こるまで denite.nvim の開発は停滞することとなったのでした。


## ddu.vim 2021/12 頃開発

https://github.com/Shougo/ddu.vim

denite.nvim の後継プラグインを開発するうえで、次のブレイクスルーとなったのは denops.vim です。

https://github.com/vim-denops/denops.vim

denops.vim は以下の特徴を持ちます。

* Vim8/neovim 両方に対応

* スクリプト言語のようにつかえて開発がしやすい

* 速度に優れている

* 型があるのでコードが堅牢になる

* ライブラリが豊富

denops.vim は私の求めていた要件をほとんど満たしていました。

denops.vim を用いて作成した ddc.vim が成功し、ようやく ddu.vim の開発が開始されることになったのです。

https://github.com/Shougo/ddc.vim

ddc.vim の開発で得られたノウハウを ddu.vim では活用し、更により実装を洗練させました。
ddu.vim はいままでにはない完成度のプラグインとなったのです。


# ddu.vim の特徴

ddc.vim は従来のファジーファインダーを過去にするほどのインパクトを秘めています。その特徴をこれから説明していきます。


## Vim8/neovim 両対応、環境依存が少なくインストールが容易

ddu.vim は denops.vim を用いているので ddc.vim のように Vim8/neovim 両方に対応し環境依存も少ないです。
特に Windows 環境なんかでは嬉しい要素ではないでしょうか。

Note: ただし Deno がうまく動作しない特殊環境では使いにくい可能性があります。それでも Python よりは環境構築が容易です


## UI プラグインによる拡張

ddu.vim 独自の概念として UI プラグインというものがあります。
telescope.nvim にも theme というものがあり、見た目を変更することができるのでそれとはどう違うのだと思う人もいるでしょう。

telescope.nvim の theme とは一部挙動や画面レイアウトを入れ替えるもので、画面設定のプリセットみたいなものでしょう。
theme を入れ替えたところで、見た目が変わるだけでありプラグインの機能そのものが変化するわけではありません。

ddu.vim の UI プラグインとは ddu.vim の view を「丸ごと」定義するためのものです。
ddu.vim は view を自由に入れ替えることができ、ddu.vim を内部で用いた派生プラグインを自由に作ることができます。
もちろん、同じフレームワークなのでそれぞれ設定や source には互換性があります。

https://github.com/Shougo/ddu-ui-ff

https://github.com/Shougo/ddu-ui-filer

unite.vim では vimfiler.vim を unite.vim ベースで実装していたり、
denite.nvim では view のコードを本体と分離して開発しやすくなっていました。
自分が理想としていたものをようやく ddu.vim で実装することができたのです。

そもそも、なぜ世の中にファジーファインダープラグインが溢れているのでしょうか。ファジーファインダープラグインの乱立といったら、自動補完やスニペット、ファイル操作プラグインとは比較になりません。
これは UI の好みが人それぞれだからだと思います。

denite.nvim はオプションで UI をカスタム可能にすることで問題に一部対処していますが、根本的な解決とはなりませんでした。
ファジーファインダーが乱立すると何が問題なのでしょうか。それは設定や派生プラグインに互換性がなくなるからです。
UI が違うファジーファインダーに対して、毎回車輪の再発明がなされることになります。

ddu.vim だとこの問題は解決しています。
ddu-ui-ff は denite.nvim ライクで標準的なファジーファインダーの UI ですが、UI が気に入らなければ自分で好きな UI をフルスクラッチすればよいのです。


## TypeScript による source 定義

ddu.vim は TypeScript で処理を記述することが可能で、型チェックの恩恵を受けることが可能です。
これは堅牢性につながります。
TypeScript はライブラリも豊富なので欲しい機能を簡単に実装できるのも優れています。
ライブラリの依存関係は自動的に解決され、ユーザーに明示的なインストール処理を要求されません。

Note: その代わり初回起動時にはライブラリをインターネットからダウンロードするオーバーヘッドがあります。インターネット接続環境でない場合には向きませんが、そのような環境にそもそもリッチな編集環境が必要なのだろうかと考えるべきでしょう


## 非同期処理


## 圧倒的なパフォーマンス

ddu.vim の起動速度は Deno の起動時間があるので、それを含めて考える必要がありますがワーストケースでも denite.nvim と同等です。
ddu.vim や denops.vim を遅延起動させる場合には注意が必要です。
とはいえ、denite.nvim は Python のロードが遅く、unite.vim も大量の Vim script を起動時にロードする必要があり起動が軽快とはいえませんでした。
ddu.vim は他のプラグインにより Deno が既に起動している状態ならば圧倒的な速度で起動します。

ddu.vim は候補の取得速度が高速です。denite.nvim も候補取得は非同期化されておりパフォーマンスもチューニングしているので特別遅いわけではないです。
比較結果は以下のようになります。

```
denite.nvim file/rec(scantree.py) 10.86 秒  40 万ファイル
denite.nvim file/rec(rg) 17.72 秒  64 万ファイル
ddu.vim file_rec(ネィティブ) 15.85 秒 98 万ファイル
```

Note: ちなみに、denite.nvim はファイルリストを全て作成する前に途中で固まったり計測終了後 channel がクラッシュするので正確な数字が出ない

ざっくりと比較すると、ddu.vim の候補取得は denite.nvim の 1.5 倍高速です。しかも denite.nvim より安定しているので denite.nvim を使う理由がもはやありません。

Note: ただし、ddu.vim でも候補の取得中に強制終了させるとクラッシュするので注意が必要


## 設定項目や設定方法の整理

ddc.vim, ddu.vim では options, params という独自の概念があります。

options とは、それぞれの source, filter, ui, kind に共通した汎用的な設定です。

params とは、source, filter, ui, kind 特有の設定です。


ddu.vim の設定には変数は一切存在せず、すべての設定は以下の custom API を用いて行うことになります。

* グローバル設定 (`ddu#custom#patch_global()`)
* ローカル設定 (`ddu#custom#patch_local()`)

ddu.vim では、何か推奨する設定をユーザーにしてほしいと思った場合、ドキュメントにてサンプルを提示することが推奨されます。
ユーザーがその指示に従うかどうかは自由です。ユーザーが選択できることこそが価値なのです。


## source, filter, ui, kind の分離

ddu.vim 本体は最小限の機能しかなく、多くの機能はプラグインとして用意されています。
ddu.vim では source, filter, ui, kind の全ての機能が分離されており、ユーザーが好きな機能を選択することができます。
もちろんこれには欠点があり、プラグインをインストールしてすぐに使い始めることはできません。

特に ui 部分が完全に分離されたのは大きいです。


## コマンドの分離

ddu.vim では denite.nvim とは異なり、コマンドも別プラグインに分離しました。
これはなぜかというと、これらのコマンドはシンタックスシュガーというべきもので誰もが必要なものではないし必要ならばユーザーが自由に作るべきものだと考えているからです。

https://github.com/Shougo/ddu-commands.vim


# 廃止した機能について

ddu.vim では ddc.vim とは異なり意図的に廃止した機能は少ないです。

## クイックマッチ機能

使用頻度が低い割に実装が大変なため。

## source の is_interactive フラグ


# 自分では実装しない機能について

自分が必要な機能は ddu.vim に一通り実装していますが、諸事情により自分では実装しない機能について説明します。ユーザーは独自に実装できます。


## メニュー機能(:Denite menu)

denite.nvim にはメニュー機能があります。
自分が使用していないので実装しないことにしました。
ただし ddu.vim には実行中の source を切り替える機能が存在するので、ユーザーがメニューを独自に実装することが可能です。


# ddu.vim の使用方法


# これからのプラグイン開発について

ddu.vim の開発は一通り完了し、自分が日常的に使う上で困らなくなりました。ddu.vim の今後は機能追加より機能の安定化に注力し、正式版のリリースを目指します。
その後は defx.nvim の後継プラグインを ddu.vim の UI プラグインとして開発する予定です。

https://github.com/Shougo/ddu-ui-filer


# GitHub sponsors について

今回のddc.vimプラグインの開発はGitHub sponsorsの皆さんの支援によって行われました。
何年もかけて開発してきたプラグインを作り直すのはとてもエネルギーの必要な作業です。
皆さんからの支援がなければ、到底実現できなかっただろうと思います。

https://zenn.dev/shougo/articles/github-sponsors

https://github.com/sponsors/Shougo/

GitHub sponsorsでの支援は確実に自分のプラグインの開発意欲の向上に役立っているので、プラグインのユーザーに広く支援をお願いします。
